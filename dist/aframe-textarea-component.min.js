(()=>{if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");AFRAME.registerComponent("textarea",{schema:{cols:{type:"int",default:40},rows:{type:"int",default:20},color:{type:"color",default:"black"},backgroundColor:{type:"color",default:"white"},selectionColor:{type:"color",default:"grey"},disabledBackgroundColor:{type:"color",default:"lightgrey"},disabled:{type:"boolean",default:!1},text:{type:"string",default:""}},init:function(){this.text=null,this.lines=[],this.lastBlink=0,this.showCursorTimeout=0,this.blinkEnabled=!this.data.disabled,this.charWidth=this.charHeight=null,this.selectionStart=this.selectionEnd=0,this.endIndexInfo=this.startIndexInfo=null,this.origin={x:0,y:0},this.textarea=null,this.background=document.createElement("a-plane"),this.background.setAttribute("color",this.data.disabled?this.data.disabledBackgroundColor:this.data.backgroundColor),this.el.appendChild(this.background),this.el.setObject3D("background",this.background.object3D),this.textAnchor=document.createElement("a-entity"),this.el.appendChild(this.textAnchor),this.textAnchor.setAttribute("text",{mode:"pre",baseline:"top",anchor:"center",font:"dejavu",wrapCount:this.data.cols,height:this.data.rows,color:this.data.color}),this._initTextarea(),this._initCursor(),this.el.addEventListener("textfontset",this._updateCharMetrics.bind(this)),this.el.addEventListener("char-metrics-changed",this._updateIndexInfo.bind(this)),this.el.addEventListener("char-metrics-changed",this._updateCursorGeometry.bind(this)),this.el.addEventListener("text-changed",this._updateLines.bind(this)),this.el.addEventListener("text-changed",this._updateDisplayText.bind(this)),this.el.addEventListener("text-changed",this._setShowCursorTimeout.bind(this)),this.el.addEventListener("selection-changed",this._updateIndexInfo.bind(this)),this.el.addEventListener("selection-changed",this._updateCursorStyle.bind(this)),this.el.addEventListener("selection-changed",this._updateCursorGeometry.bind(this)),this.el.addEventListener("selection-changed",this._updateHorizontalOrigin.bind(this)),this.el.addEventListener("selection-changed",this._setShowCursorTimeout.bind(this)),this.el.addEventListener("lines-changed",this._updateIndexInfo.bind(this)),this.el.addEventListener("index-info-changed",this._updateOrigin.bind(this)),this.el.addEventListener("index-info-changed",this._updateCursorGeometry.bind(this)),this.el.addEventListener("index-info-changed",this._updateHorizontalOrigin.bind(this)),this.el.addEventListener("origin-changed",this._updateCursorGeometry.bind(this)),this.el.addEventListener("origin-changed",this._updateDisplayText.bind(this)),this.el.addEventListener("click",this.focus.bind(this))},update:function(t){this.data.text!==t.text&&this._updateTextarea(),this.data.backgroundColor===t.backgroundColor&&this.data.disabledBackgroundColor===t.disabledBackgroundColor||this.background.setAttribute("color",this.data.disabled?this.data.disabledBackgroundColor:this.data.backgroundColor),this.data.disabled!==t.disabled&&(this.blinkEnabled=!this.data.disabled,this.textarea.disabled=this.data.disabled,this.cursorMesh.visible=!this.data.disabled,this.background.setAttribute("color",this.data.disabled?this.data.disabledBackgroundColor:this.data.backgroundColor))},focus:function(){this.textarea.focus()},blur:function(){this.textarea.blur()},getText:function(){return this.textarea.value},_initTextarea:function(){this.textarea=document.createElement("textarea"),document.body.appendChild(this.textarea),this._updateTextarea()},_updateTextarea:function(){this.textarea.style.whiteSpace="pre",this.textarea.style.overflow="hidden",this.textarea.style.opacity="0",this.textarea.cols=this.data.cols,this.textarea.rows=this.data.rows,this.textarea.value=this.data.text,this.textarea.selectionStart=0,this.textarea.selectionEnd=0,this._updateIndexInfo()},_initCursor:function(){this.cursor=document.createElement("a-entity"),this.cursorGeo=new THREE.PlaneGeometry(1,1),this.cursorMat=new THREE.MeshBasicMaterial({color:"black",transparent:!0,opacity:.5}),this.cursorMesh=new THREE.Mesh(this.cursorGeo,this.cursorMat),this.cursor.setObject3D("mesh",this.cursorMesh),this.el.appendChild(this.cursor)},_emit:function(t,e){this.el.emit(t,e)},_updateCharMetrics:function(t){const e=this.textAnchor.components.text.geometry.layout,i=t.detail.fontObj.widthFactor;this.charWidth=i*this.textAnchor.object3DMap.text.scale.x,this.charHeight=this.charWidth*e.lineHeight/i,this.textAnchor.setAttribute("position",{x:0,y:this.charHeight*this.data.rows/2,z:0}),this.background.setAttribute("scale",{x:1.05,y:this.charHeight*this.data.rows*1.05,z:1}),this.background.setAttribute("position",{x:0,y:0,z:0}),this._emit("char-metrics-changed")},_checkAndUpdateSelection:function(){if(this.selectionStart===this.textarea.selectionStart&&this.selectionEnd===this.textarea.selectionEnd)return;const t=this.selectionStart,e=this.selectionEnd;this.selectionStart=this.textarea.selectionStart,this.selectionEnd=this.textarea.selectionEnd,this._emit("selection-changed",{start:{old:t,new:this.selectionStart,changed:this.selectionStart!==t},end:{old:e,new:this.selectionEnd,changed:this.selectionEnd!==e}})},_setShowCursorTimeout:function(){this.showCursorTimeout=500},tick:function(t,e){this._updateCursorVisibility(e),this._checkAndUpdateSelection(),this._checkAndUpdateText()},_updateCursorVisibility:function(t){document.activeElement===this.textarea?this.showCursorTimeout>0?(this.showCursorTimeout-=t,this.cursorMesh.visible=!0):this.blinkEnabled?Date.now()-this.lastBlink>500&&(this.cursorMesh.visible=!this.cursorMesh.visible,this.lastBlink=Date.now()):this.selectionStart!==this.selectionEnd&&(this.cursorMesh.visible=!0):this.cursorMesh.visible=!1},_getIndexInfo:function(t,e){const i=Math.max(0,t),s=this.lines[i];return{line:s,x:(e-s.start)*this.charWidth,y:-this.charHeight*i+-this.charHeight/2}},_updateIndexInfo:function(){if(!this.lines.length)return;const t=this.startIndexInfo&&this.startIndexInfo.line.index,e=this.endIndexInfo&&this.endIndexInfo.line.index;var i;this.startIndexInfo=null,this.endIndexInfo=null;var s=!1,n=!1;for(i=0;i<=this.lines.length;i++){const h=this.lines[i-1],a=i===this.lines.length?h.start+h.length+1:this.lines[i].start;if(a>this.selectionStart&&!this.startIndexInfo&&(this.startIndexInfo=this._getIndexInfo(i-1,this.selectionStart),this.startIndexInfo.line.index!==t&&(s=!0)),a>this.selectionEnd){this.endIndexInfo=this._getIndexInfo(i-1,this.selectionEnd),this.endIndexInfo.line.index!==e&&(n=!0);break}}(s||n)&&this._emit("index-info-changed",{start:{changed:s},end:{changed:n}})},_updateOrigin:function(t){var e=!1;if(t.detail.end.changed){const t=this.origin.y+this.data.rows-1;this.endIndexInfo.line.index>t?(this.origin.y=this.endIndexInfo.line.index+1-this.data.rows,e=!0):this.endIndexInfo.line.index<this.origin.y&&(this.origin.y=this.endIndexInfo.line.index,e=!0)}t.detail.start.changed&&this.startIndexInfo.line.index<this.origin.y&&(this.origin.y=this.startIndexInfo.line.index,e=!0),e&&this._emit("origin-changed")},_updateHorizontalOrigin:function(t){if(!this.endIndexInfo)return;var e=!0;if(t.detail.end.changed){const t=this.selectionEnd-this.endIndexInfo.line.start;t>this.origin.x+this.data.cols?(this.origin.x=t-this.data.cols,e=!0):t<this.origin.x&&(this.origin.x=t,e=!0)}const i=this.selectionStart-this.startIndexInfo.line.start;t.detail.start.changed&&(i>this.origin.x+this.data.cols?(this.origin.x=i-this.data.cols,e=!0):i<this.origin.x&&(this.origin.x=i,e=!0)),e&&this._emit("origin-changed")},_updateCursorStyle:function(){this.selectionStart===this.selectionEnd?(this.blinkEnabled=!0,this.cursorMat.color.setStyle("black"),this.cursorMat.transparent=!1):(this.blinkEnabled=!1,this.cursorMat.color.setStyle(this.data.selectionColor),this.cursorMesh.visible=!0,this.cursorMat.transparent=!0)},_updateCursorGeometry:function(){if(!this.startIndexInfo)return;const t=Math.max(this.origin.y,this.startIndexInfo.line.index),e=Math.min(this.origin.y+this.data.rows-1,this.endIndexInfo.line.index),i=this.origin.x+this.data.cols,s=[],n=new THREE.Object3D;for(var h=t;h<=e;h++){var a,r=0;if(e===t){r=Math.max(this.origin.x,this.selectionStart-this.startIndexInfo.line.start);const t=Math.min(i,this.selectionEnd-this.startIndexInfo.line.start);a=Math.max(.2,t-r)}else{var o;h===this.startIndexInfo.line.index?(r=Math.max(this.origin.x,this.selectionStart-this.startIndexInfo.line.start),o=Math.min(i,this.startIndexInfo.line.length)):h===this.endIndexInfo.line.index?(r=this.origin.x,o=Math.min(i,this.selectionEnd-this.endIndexInfo.line.start)):(r=this.origin.x,o=Math.min(i,this.lines[h].length)),a=o-r}n.scale.set(this.charWidth*a,this.charHeight,1),n.position.set(r*this.charWidth+this.charWidth*a/2-.5-this.origin.x*this.charWidth,-h*this.charHeight+this.charHeight*this.data.rows/2-this.charHeight/2+this.origin.y*this.charHeight,.002),n.updateMatrix();const d=new THREE.PlaneGeometry(1,1);d.applyMatrix4(n.matrix),s.push(d)}this.cursorMesh.geometry=THREE.BufferGeometryUtils.mergeBufferGeometries(s),this.cursorMesh.geometry.verticesNeedUpdate=!0,this.cursorMesh.geometry.needsUpdate=!0},_updateLines:function(){this.lines=[];const t=this.text.split("\n");for(var e=0,i=0;i<t.length;i++)this.lines[i]={index:i,length:t[i].length,start:e},e+=t[i].length+1;this._emit("lines-changed")},_getViewportText:function(){return this.text.split("\n").slice(this.origin.y,this.origin.y+this.data.rows).map(function(t){return t.substr(this.origin.x,this.data.cols)||" "}.bind(this)).join("\n")},_updateDisplayText:function(){this.textAnchor.setAttribute("text",{value:this._getViewportText()})},_checkAndUpdateText:function(){const t=this.textarea.value;t!==this.text&&(this.text=t,this._emit("text-changed"))}})})();